{
   "Resources" : {
      "BastionHost" : {
         "Type" : "AWS::EC2::Instance",
         "Properties" : {
            "ImageId" : "ami-6869aa05",
            "InstanceType" : "t2.micro",
            "KeyName" : {
               "Ref" : "KeyName"
            },
            "SecurityGroupIds" : [
               {
                  "Ref" : "BastionSecurityGroup"
               }
            ],
            "SubnetId" : {
               "Ref" : "PublicSubnet1b"
            }
         }
      },
      "NatGateway1b" : {
         "Type" : "AWS::EC2::NatGateway",
         "Properties" : {
            "SubnetId" : {
               "Ref" : "PublicSubnet1b"
            },
            "AllocationId" : {
               "Fn::GetAtt" : [
                  "NatEip1b",
                  "AllocationId"
               ]
            }
         }
      },
      "PublicRouteTable" : {
         "Properties" : {
            "VpcId" : {
               "Ref" : "VPC"
            }
         },
         "Type" : "AWS::EC2::RouteTable",
         "DependsOn" : "VPC"
      },
      "VPC" : {
         "Properties" : {
            "EnableDnsHostnames" : "true",
            "EnableDnsSupport" : "true",
            "CidrBlock" : "10.0.0.0/16"
         },
         "Type" : "AWS::EC2::VPC"
      },
      "InternetGateway" : {
         "Type" : "AWS::EC2::InternetGateway",
         "DependsOn" : [
            "VPC",
            "PublicRouteTable"
         ]
      },
      "VPCGatewayAttachment" : {
         "DependsOn" : [
            "VPC",
            "InternetGateway"
         ],
         "Type" : "AWS::EC2::VPCGatewayAttachment",
         "Properties" : {
            "InternetGatewayId" : {
               "Ref" : "InternetGateway"
            },
            "VpcId" : {
               "Ref" : "VPC"
            }
         }
      },
      "PublicSubnetRouteTableAssociation1c" : {
         "Type" : "AWS::EC2::SubnetRouteTableAssociation",
         "Properties" : {
            "RouteTableId" : {
               "Ref" : "PublicRouteTable"
            },
            "SubnetId" : {
               "Ref" : "PublicSubnet1c"
            }
         }
      },
      "NatEip1b" : {
         "Properties" : {
            "Domain" : "VPC"
         },
         "Type" : "AWS::EC2::EIP"
      },
      "BastionSecurityGroup" : {
         "Type" : "AWS::EC2::SecurityGroup",
         "Properties" : {
            "SecurityGroupIngress" : {
               "CidrIp" : "0.0.0.0/0",
               "FromPort" : "22",
               "ToPort" : "22",
               "IpProtocol" : "tcp"
            },
            "GroupDescription" : "Allow SSH traffic to bastion host",
            "VpcId" : {
               "Ref" : "VPC"
            },
            "SecurityGroupEgress" : {
               "FromPort" : "22",
               "CidrIp" : "0.0.0.0/0",
               "IpProtocol" : "tcp",
               "ToPort" : "22"
            }
         }
      },
      "PrivateRoute1c" : {
         "Type" : "AWS::EC2::Route",
         "Properties" : {
            "RouteTableId" : {
               "Ref" : "PrivateRouteTable1c"
            },
            "DestinationCidrBlock" : "0.0.0.0/0",
            "NatGatewayId" : {
               "Ref" : "NatGateway1c"
            }
         },
         "DependsOn" : [
            "NatGateway1c",
            "PrivateRouteTable1c"
         ]
      },
      "PublicSubnet1c" : {
         "Type" : "AWS::EC2::Subnet",
         "Properties" : {
            "CidrBlock" : "10.0.3.0/24",
            "AvailabilityZone" : "us-east-1d",
            "VpcId" : {
               "Ref" : "VPC"
            }
         }
      },
      "NatEip1c" : {
         "Properties" : {
            "Domain" : "VPC"
         },
         "Type" : "AWS::EC2::EIP"
      },
      "SecurityGroup" : {
         "Properties" : {
            "GroupDescription" : "App Server Security Group",
            "VpcId" : {
               "Ref" : "VPC"
            },
            "SecurityGroupIngress" : [
               {
                  "IpProtocol" : "tcp",
                  "ToPort" : "22",
                  "CidrIp" : "10.0.0.0/16",
                  "FromPort" : "22"
               },
               {
                  "ToPort" : "5432",
                  "IpProtocol" : "tcp",
                  "FromPort" : "5432",
                  "CidrIp" : "10.0.0.0/16"
               },
               {
                  "IpProtocol" : "tcp",
                  "ToPort" : "80",
                  "FromPort" : "80",
                  "CidrIp" : "10.0.0.0/16"
               },
               {
                  "CidrIp" : "10.0.0.0/16",
                  "FromPort" : "6379",
                  "ToPort" : "6379",
                  "IpProtocol" : "tcp"
               }
            ]
         },
         "Type" : "AWS::EC2::SecurityGroup"
      },
      "NatGateway1c" : {
         "Type" : "AWS::EC2::NatGateway",
         "Properties" : {
            "SubnetId" : {
               "Ref" : "PublicSubnet1c"
            },
            "AllocationId" : {
               "Fn::GetAtt" : [
                  "NatEip1c",
                  "AllocationId"
               ]
            }
         }
      },
      "PublicRoute" : {
         "Type" : "AWS::EC2::Route",
         "Properties" : {
            "RouteTableId" : {
               "Ref" : "PublicRouteTable"
            },
            "GatewayId" : {
               "Ref" : "InternetGateway"
            },
            "DestinationCidrBlock" : "0.0.0.0/0"
         },
         "DependsOn" : [
            "VPCGatewayAttachment",
            "InternetGateway",
            "PublicRouteTable"
         ]
      },
      "PrivateRoute1b" : {
         "Type" : "AWS::EC2::Route",
         "Properties" : {
            "NatGatewayId" : {
               "Ref" : "NatGateway1b"
            },
            "DestinationCidrBlock" : "0.0.0.0/0",
            "RouteTableId" : {
               "Ref" : "PrivateRouteTable1b"
            }
         },
         "DependsOn" : [
            "NatGateway1b",
            "PrivateRouteTable1b"
         ]
      },
      "PublicSubnetRouteTableAssociation1b" : {
         "Type" : "AWS::EC2::SubnetRouteTableAssociation",
         "Properties" : {
            "RouteTableId" : {
               "Ref" : "PublicRouteTable"
            },
            "SubnetId" : {
               "Ref" : "PublicSubnet1b"
            }
         }
      },
      "PrivateSubnetRouteTableAssociation1b" : {
         "Type" : "AWS::EC2::SubnetRouteTableAssociation",
         "Properties" : {
            "RouteTableId" : {
               "Ref" : "PrivateRouteTable1b"
            },
            "SubnetId" : {
               "Ref" : "PrivateSubnet1b"
            }
         }
      },
      "PublicSubnet1b" : {
         "Type" : "AWS::EC2::Subnet",
         "Properties" : {
            "CidrBlock" : "10.0.1.0/24",
            "AvailabilityZone" : "us-east-1b",
            "VpcId" : {
               "Ref" : "VPC"
            }
         }
      },
      "BastionHostEIPAssociation" : {
         "DependsOn" : [
            "BastionHostEIP",
            "BastionHost"
         ],
         "Properties" : {
            "InstanceId" : {
               "Ref" : "BastionHost"
            },
            "AllocationId" : {
               "Fn::GetAtt" : [
                  "BastionHostEIP",
                  "AllocationId"
               ]
            }
         },
         "Type" : "AWS::EC2::EIPAssociation"
      },
      "PrivateRouteTable1c" : {
         "Properties" : {
            "VpcId" : {
               "Ref" : "VPC"
            }
         },
         "Type" : "AWS::EC2::RouteTable"
      },
      "PrivateRouteTable1b" : {
         "Type" : "AWS::EC2::RouteTable",
         "Properties" : {
            "VpcId" : {
               "Ref" : "VPC"
            }
         }
      },
      "PrivateSubnet1c" : {
         "Type" : "AWS::EC2::Subnet",
         "Properties" : {
            "VpcId" : {
               "Ref" : "VPC"
            },
            "AvailabilityZone" : "us-east-1d",
            "CidrBlock" : "10.0.2.0/24"
         }
      },
      "BastionHostEIP" : {
         "Properties" : {
            "Domain" : "VPC"
         },
         "Type" : "AWS::EC2::EIP"
      },
      "PrivateSubnetRouteTableAssociation1c" : {
         "Type" : "AWS::EC2::SubnetRouteTableAssociation",
         "Properties" : {
            "SubnetId" : {
               "Ref" : "PrivateSubnet1c"
            },
            "RouteTableId" : {
               "Ref" : "PrivateRouteTable1c"
            }
         }
      },
      "PrivateSubnet1b" : {
         "Type" : "AWS::EC2::Subnet",
         "Properties" : {
            "VpcId" : {
               "Ref" : "VPC"
            },
            "AvailabilityZone" : "us-east-1b",
            "CidrBlock" : "10.0.0.0/24"
         }
      }
   },
   "Outputs" : {
      "SecurityGroupId" : {
         "Description" : "Main VPC Security Group id",
         "Value" : {
            "Ref" : "SecurityGroup"
         }
      },
      "KeyName" : {
         "Value" : {
            "Ref" : "KeyName"
         },
         "Description" : "EC2 Keyname to Access Bastion Host"
      },
      "PublicSubnet1b" : {
         "Description" : "Public ELB Subnet 1",
         "Value" : {
            "Ref" : "PublicSubnet1b"
         }
      },
      "VPC" : {
         "Description" : "VPC id",
         "Value" : {
            "Ref" : "VPC"
         }
      },
      "BastionHostEIP" : {
         "Description" : "Bastion Host IP Address",
         "Value" : {
            "Ref" : "BastionHostEIP"
         }
      },
      "PrivateSubnet1b" : {
         "Description" : "Private EC2 Instance Subnet 1",
         "Value" : {
            "Ref" : "PrivateSubnet1b"
         }
      },
      "PrivateSubnet1c" : {
         "Description" : "Private EC2 Instance Subnet 2",
         "Value" : {
            "Ref" : "PrivateSubnet1c"
         }
      },
      "PublicSubnet1c" : {
         "Description" : "Public EC2 Instance Subnet 2",
         "Value" : {
            "Ref" : "PublicSubnet1c"
         }
      }
   },
   "AWSTemplateFormatVersion" : "2010-09-09",
   "Parameters" : {
      "KeyName" : {
         "ConstraintDescription" : "Must be a valid keyname",
         "Type" : "AWS::EC2::KeyPair::KeyName"
      }
   }
}
